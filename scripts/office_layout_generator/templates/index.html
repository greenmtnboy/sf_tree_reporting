<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Office Layout Generator — 12'7" × 8'5"</title>
  <style>
    /* ------------------------------------------------------------------ */
    /* Base                                                                */
    /* ------------------------------------------------------------------ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:       #f5f0eb;
      --surface:  #ffffff;
      --accent:   #7c6853;
      --accent-l: #a89279;
      --text:     #3a3028;
      --text-m:   #6b5e50;
      --border:   #ddd3c8;
      --radius:   12px;
      --shadow:   0 2px 12px rgba(0,0,0,.08);
    }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    a { color: var(--accent); }

    /* ------------------------------------------------------------------ */
    /* Header                                                              */
    /* ------------------------------------------------------------------ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1.5rem 2rem;
      text-align: center;
    }
    header h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--accent);
    }
    header p { color: var(--text-m); font-size: .95rem; margin-top: .25rem; }

    /* room info bar */
    .room-info {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: .75rem;
      font-size: .85rem;
      color: var(--text-m);
    }
    .room-info span::before {
      content: '•';
      margin-right: .4rem;
      color: var(--accent-l);
    }

    /* ------------------------------------------------------------------ */
    /* Main layout                                                         */
    /* ------------------------------------------------------------------ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    /* ------------------------------------------------------------------ */
    /* Layout selector cards                                               */
    /* ------------------------------------------------------------------ */
    .section-title {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--accent);
    }
    .layout-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .layout-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 1.1rem;
      cursor: pointer;
      transition: border-color .2s, box-shadow .2s;
    }
    .layout-card:hover { border-color: var(--accent-l); box-shadow: var(--shadow); }
    .layout-card.selected { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,104,83,.18); }
    .layout-card h3 { font-size: 1rem; margin-bottom: .2rem; }
    .layout-card .tagline { font-size: .82rem; color: var(--text-m); }

    /* ------------------------------------------------------------------ */
    /* Description panel                                                   */
    /* ------------------------------------------------------------------ */
    .detail-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
      display: none;
    }
    .detail-panel.visible { display: block; }
    .detail-panel h3 { font-size: 1.05rem; color: var(--accent); margin-bottom: .5rem; }
    .detail-panel p { font-size: .9rem; color: var(--text-m); }
    .placement-list { margin-top: .75rem; font-size: .85rem; }
    .placement-list dt { font-weight: 600; display: inline; }
    .placement-list dd { display: inline; margin-left: .25rem; color: var(--text-m); }
    .placement-list dd::after { content: ''; display: block; margin-bottom: .25rem; }

    /* ------------------------------------------------------------------ */
    /* Action bar                                                          */
    /* ------------------------------------------------------------------ */
    .action-bar {
      display: flex;
      align-items: flex-end;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .feedback-box {
      flex: 1;
      min-width: 240px;
    }
    .feedback-box label {
      display: block;
      font-size: .85rem;
      font-weight: 500;
      margin-bottom: .35rem;
      color: var(--text-m);
    }
    .feedback-box textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: .6rem .75rem;
      font-size: .9rem;
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }
    .feedback-box textarea:focus { outline: none; border-color: var(--accent); }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .7rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { background: var(--accent-l); }
    .btn-primary:disabled { opacity: .5; cursor: not-allowed; }
    .btn-outline {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
    }
    .btn-outline:hover { background: rgba(124,104,83,.07); }

    /* ------------------------------------------------------------------ */
    /* Results gallery                                                     */
    /* ------------------------------------------------------------------ */
    .results-title {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--accent);
    }
    .results-empty {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-m);
      font-size: .95rem;
    }
    .result-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .result-card img {
      width: 100%;
      display: block;
      max-height: 480px;
      object-fit: contain;
      background: #e8e0d8;
    }
    .result-meta {
      padding: 1rem 1.25rem;
    }
    .result-meta h4 { font-size: 1rem; margin-bottom: .35rem; }
    .result-meta .model-tag {
      display: inline-block;
      background: #ece6df;
      color: var(--accent);
      font-size: .75rem;
      padding: .15rem .5rem;
      border-radius: 4px;
      margin-bottom: .5rem;
    }
    .result-meta .feedback-used {
      font-size: .82rem;
      color: var(--text-m);
      font-style: italic;
      margin-bottom: .5rem;
    }
    /* Grade bar */
    .grade-section { margin-top: .5rem; }
    .grade-section summary {
      cursor: pointer;
      font-size: .9rem;
      font-weight: 600;
      color: var(--accent);
    }
    .grade-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: .5rem;
      margin-top: .5rem;
    }
    .grade-item {
      display: flex;
      justify-content: space-between;
      font-size: .82rem;
      padding: .25rem .5rem;
      background: #f8f4f0;
      border-radius: 4px;
    }
    .grade-item .label { color: var(--text-m); }
    .grade-item .score { font-weight: 700; color: var(--accent); }
    .grade-feedback {
      margin-top: .5rem;
      font-size: .85rem;
      color: var(--text-m);
      padding: .5rem .75rem;
      background: #fdf9f5;
      border-left: 3px solid var(--accent-l);
      border-radius: 4px;
    }
    .overall-badge {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      font-size: .85rem;
      font-weight: 700;
      padding: .2rem .65rem;
      border-radius: 6px;
      margin-left: .5rem;
    }

    /* ------------------------------------------------------------------ */
    /* Spinner                                                             */
    /* ------------------------------------------------------------------ */
    .spinner-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(245,240,235,.85);
      z-index: 100;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 1rem;
    }
    .spinner-overlay.active { display: flex; }
    .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner-text { font-size: 1rem; color: var(--text-m); }

    /* ------------------------------------------------------------------ */
    /* Floor plan mini-diagram                                             */
    /* ------------------------------------------------------------------ */
    .floor-plan-mini {
      margin: 1rem auto 1.5rem;
      max-width: 320px;
    }
    .floor-plan-mini svg {
      width: 100%;
      height: auto;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .action-bar { flex-direction: column; }
      header h1 { font-size: 1.3rem; }
      .room-info { flex-direction: column; gap: .3rem; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>Office Layout Generator</h1>
    <p>Design a cozy dual-purpose office &amp; guest room</p>
    <div class="room-info">
      <span>12'7" &times; 8'5"</span>
      <span>Window on long wall</span>
      <span>Door opposite</span>
      <span>Desk + Chair + Sleeper Sofa</span>
    </div>
  </header>

  <!-- Floor plan reference -->
  <div class="container">
    <div class="floor-plan-mini">
      <svg viewBox="0 0 320 210" xmlns="http://www.w3.org/2000/svg">
        <!-- Room outline -->
        <rect x="10" y="10" width="300" height="190" rx="2" fill="#fdf9f5" stroke="#7c6853" stroke-width="2"/>
        <!-- Window (top long wall) -->
        <line x1="110" y1="10" x2="210" y2="10" stroke="#5ba3d9" stroke-width="5"/>
        <text x="160" y="5" text-anchor="middle" font-size="10" fill="#5ba3d9">window</text>
        <!-- Door (bottom long wall) -->
        <rect x="55" y="195" width="30" height="5" fill="#b07a4a"/>
        <!-- Door swing arc -->
        <path d="M 85 200 A 30 30 0 0 1 55 170" fill="none" stroke="#b07a4a" stroke-width="1" stroke-dasharray="3,2"/>
        <text x="70" y="212" text-anchor="middle" font-size="10" fill="#b07a4a">door</text>
        <!-- Dimension labels -->
        <text x="160" y="115" text-anchor="middle" font-size="12" fill="#999">12'7"</text>
        <text x="335" y="105" text-anchor="middle" font-size="12" fill="#999" transform="rotate(90, 335, 105)">8'5"</text>
        <!-- Long wall labels -->
        <text x="5" y="105" text-anchor="middle" font-size="9" fill="#bbb" transform="rotate(-90,5,105)">8'5" (short)</text>
      </svg>
    </div>

    <!-- Layout selector -->
    <div class="section-title">Choose a Layout</div>
    <div class="layout-grid" id="layoutGrid"></div>

    <!-- Detail panel -->
    <div class="detail-panel" id="detailPanel">
      <h3 id="detailName"></h3>
      <p id="detailDesc"></p>
      <dl class="placement-list" id="detailPlacement"></dl>
    </div>

    <!-- Action bar -->
    <div class="action-bar">
      <div class="feedback-box">
        <label for="feedbackInput">Feedback / refinement instructions (optional)</label>
        <textarea id="feedbackInput" placeholder="e.g. 'Make it warmer with more plants' or 'Swap the desk and sofa positions'"></textarea>
      </div>
      <button class="btn btn-primary" id="generateBtn" disabled>
        Generate Visualization
      </button>
    </div>

    <!-- Results -->
    <div class="results-title">Generated Layouts</div>
    <div id="results">
      <div class="results-empty" id="emptyState">
        Select a layout above and click <strong>Generate</strong> to see AI-rendered visualizations graded against the floor plan.
      </div>
    </div>
  </div>

  <!-- Spinner -->
  <div class="spinner-overlay" id="spinner">
    <div class="spinner"></div>
    <div class="spinner-text" id="spinnerText">Generating layout image...</div>
  </div>

  <script>
    // -------------------------------------------------------------------
    // State
    // -------------------------------------------------------------------
    let layouts = [];
    let selectedId = null;

    const grid = document.getElementById('layoutGrid');
    const detail = document.getElementById('detailPanel');
    const detailName = document.getElementById('detailName');
    const detailDesc = document.getElementById('detailDesc');
    const detailPlacement = document.getElementById('detailPlacement');
    const feedbackInput = document.getElementById('feedbackInput');
    const genBtn = document.getElementById('generateBtn');
    const resultsDiv = document.getElementById('results');
    const emptyState = document.getElementById('emptyState');
    const spinner = document.getElementById('spinner');
    const spinnerText = document.getElementById('spinnerText');

    // -------------------------------------------------------------------
    // Init — fetch layouts
    // -------------------------------------------------------------------
    fetch('/api/layouts')
      .then(r => r.json())
      .then(data => {
        layouts = data;
        renderGrid();
        loadHistory();
      });

    function renderGrid() {
      grid.innerHTML = '';
      layouts.forEach(l => {
        const card = document.createElement('div');
        card.className = 'layout-card' + (l.id === selectedId ? ' selected' : '');
        card.innerHTML = `<h3>${l.name}</h3><div class="tagline">${l.tagline}</div>`;
        card.addEventListener('click', () => selectLayout(l.id));
        grid.appendChild(card);
      });
    }

    function selectLayout(id) {
      selectedId = id;
      genBtn.disabled = false;
      renderGrid();
      const l = layouts.find(x => x.id === id);
      detailName.textContent = l.name;
      detailDesc.textContent = l.description;
      let placementHtml = '';
      for (const [k, v] of Object.entries(l.furniture_placement)) {
        placementHtml += `<dt>${k}:</dt><dd>${v}</dd>`;
      }
      detailPlacement.innerHTML = placementHtml;
      detail.classList.add('visible');
    }

    // -------------------------------------------------------------------
    // Generate
    // -------------------------------------------------------------------
    genBtn.addEventListener('click', generate);

    async function generate() {
      if (!selectedId) return;
      genBtn.disabled = true;
      spinner.classList.add('active');
      spinnerText.textContent = 'Generating layout image with Gemini...';

      try {
        const resp = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            layout_id: selectedId,
            feedback: feedbackInput.value,
          }),
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.error || 'Generation failed');
        }

        const entry = await resp.json();
        prependResult(entry);
        emptyState.style.display = 'none';
      } catch (e) {
        alert('Error: ' + e.message);
      } finally {
        spinner.classList.remove('active');
        genBtn.disabled = false;
      }
    }

    // -------------------------------------------------------------------
    // Render a result card
    // -------------------------------------------------------------------
    function prependResult(entry) {
      // Remove empty state
      const existing = document.getElementById('emptyState');
      if (existing) existing.style.display = 'none';

      // Ensure result-list container
      let list = resultsDiv.querySelector('.result-list');
      if (!list) {
        list = document.createElement('div');
        list.className = 'result-list';
        resultsDiv.appendChild(list);
      }

      const card = document.createElement('div');
      card.className = 'result-card';

      const g = entry.grade || {};
      const overall = g.overall != null ? Number(g.overall).toFixed(1) : '—';
      const gradeKeys = ['room_proportions','furniture_presence','furniture_placement','window_door','style_cozy','realism'];

      card.innerHTML = `
        <img src="/images/${entry.filename}" alt="${entry.layout_name}" loading="lazy"/>
        <div class="result-meta">
          <h4>${entry.layout_name}</h4>
          <span class="model-tag">${entry.model}</span>
          ${entry.feedback_used ? `<div class="feedback-used">"${entry.feedback_used}"</div>` : ''}
          <details class="grade-section">
            <summary>Quality Grade <span class="overall-badge">${overall}/10</span></summary>
            <div class="grade-grid">
              ${gradeKeys.map(k => `
                <div class="grade-item">
                  <span class="label">${k.replace(/_/g, ' ')}</span>
                  <span class="score">${g[k] != null ? g[k] : '—'}</span>
                </div>
              `).join('')}
            </div>
            ${g.feedback ? `<div class="grade-feedback">${g.feedback}</div>` : ''}
          </details>
          <div style="margin-top:.75rem;">
            <button class="btn btn-outline btn-sm" onclick="regen('${entry.layout_id}', this)">
              Regenerate with feedback
            </button>
          </div>
        </div>
      `;
      list.prepend(card);
    }

    // Quick regen: copies layout id + prompts for feedback
    function regen(layoutId, btn) {
      selectLayout(layoutId);
      feedbackInput.focus();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // -------------------------------------------------------------------
    // Load history on page load
    // -------------------------------------------------------------------
    async function loadHistory() {
      try {
        const resp = await fetch('/api/history');
        const data = await resp.json();
        if (data.length) {
          emptyState.style.display = 'none';
          data.forEach(entry => prependResult(entry));
        }
      } catch (e) {
        console.warn('Could not load history', e);
      }
    }
  </script>
</body>
</html>
